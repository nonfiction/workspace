#!/usr/bin/env zsh

# https://wiki.archlinux.org/title/XDG_Base_Directory
etc="/usr/local/etc"      # XDG_CONFIG_HOME
share="/usr/local/share"  # XDG_DATA_HOME
cache="/usr/local/cache"  # XDG_CACHE_HOME

bin="/root/platform/bin"  # platform bin directory

# Shell helper functions
source $etc/zsh/helpers.sh

# symlink configs to home directory
mkdir -p /work/.local
has /work/.local/share || ln -s $share /work/.local/share
has /work/.config || ln -s $etc /work/.config
has /work/.cache || ln -s $cache /work/.cache

# Update password for user
SUDO_PASSWORD=$($bin/env SUDO_PASSWORD "secret")
defined "$SUDO_PASSWORD" && echo "work:${SUDO_PASSWORD}" | chpasswd

# Git & Github
GIT_NAME="$($bin/env GIT_NAME "nonfiction")" \
GIT_EMAIL=$($bin/env GIT_EMAIL "web@nonfiction.ca") \
esh $etc/git/config.esh > $etc/git/config

GITHUB_USER=$($bin/env GITHUB_USER "nonfiction-studios") \
GITHUB_TOKEN=$($bin/env GITHUB_TOKEN) \
esh $etc/git/credentials.esh > $etc/git/credentials

# Settings for mysql client
ln -sf $etc/mysql/.my.cnf /work/.my.cnf

DB_USER=$($bin/env DB_USER "root") \
DB_PASSWORD=$($bin/env DB_PASSWORD "secret") \
DB_HOST=$($bin/env DB_HOST "127.0.0.1") \
DB_PORT=$($bin/env DB_PORT "3306") \
esh $etc/mysql/.my.cnf.esh > $etc/mysql/.my.cnf

# Password for code-server
CODE_PASSWORD=$($bin/env CODE_PASSWORD "secret") \
esh $etc/code-server/config.yaml.esh > $etc/code-server/config.yaml 

# platform / swarm command
git_clone_pull https://github.com/nonfiction/platform.git $share/platform
ln -sf $share/platform/swarm/swarm /usr/local/bin/swarm

# workspace (this repo)
git_clone_pull https://github.com/nonfiction/workspace.git $share/workspace
has $share/workspace/share/bin/update && $share/workspace/share/bin/update
